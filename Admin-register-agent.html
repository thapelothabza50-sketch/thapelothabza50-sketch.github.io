<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Agent Account | Campus Collective</title>
    <link rel="icon" type="image/x-icon" href="Images/campus collective icon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- 3D SPINNING LOADER STYLES --- */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.8s ease-out, visibility 0.8s;
            visibility: hidden; opacity: 0;
        }
        .logo-container { position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .loader-ring {
            position: absolute; width: 150px; height: 150px;
            border: 3px solid transparent; border-top: 3px solid #2563eb;
            border-bottom: 3px solid #ff6600; border-radius: 50%;
            animation: spin-ring 1.5s linear infinite;
        }
        .loader-logo { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; animation: spin-3d 3s infinite ease-in-out; }
        
        @keyframes spin-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-3d { 0% { transform: rotateY(0deg); } 50% { transform: rotateY(180deg); } 100% { transform: rotateY(360deg); } }

        #main-form-container { opacity: 0; transition: opacity 1s ease-out; }
        .content-visible { opacity: 1 !important; }
    </style>
</head>
<body class="bg-gray-50 p-6">

    <div id="loader-overlay">
        <div class="logo-container">
            <div class="loader-ring"></div>
            <img src="Images/Campus collective logo origin.jpg" alt="Loading..." class="loader-logo">
        </div>
        <p id="loader-text" class="mt-8 text-blue-600 font-black uppercase tracking-widest animate-pulse">Initializing...</p>
    </div>

    <div id="main-form-container" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-10">
        <div class="flex items-center gap-4 mb-6 border-b pb-4">
             <img src="Images/Campus collective logo origin.jpg" alt="Logo" class="w-12 h-12 rounded-full">
             <h2 class="text-2xl font-bold text-gray-800">Register New Agent</h2>
        </div>
        
        <div id="msg" class="hidden p-3 mb-4 rounded text-sm font-bold"></div>

        <form id="create-agent-form" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Full Name</label>
                <input type="text" id="fullName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter full name">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Student Email</label>
                <input type="email" id="email" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="student@university.ac.za">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Student Number (Agent ID)</label>
                <input type="text" id="agentId" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. 21908443">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Phone Number</label>
                <input type="text" id="phone" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="012 345 6789">
            </div>
            <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-black py-4 rounded-lg hover:bg-blue-700 transition uppercase tracking-widest shadow-lg">
                Create & Send Welcome Email
            </button>
            <button type="button" onclick="window.location.href='management.html'" class="w-full text-gray-500 font-bold py-2 hover:underline text-sm">
                Cancel & Return to Dashboard
            </button>
        </form>
    </div>

    <script>
        const loader = document.getElementById('loader-overlay');
        const loaderText = document.getElementById('loader-text');
        const formContainer = document.getElementById('main-form-container');

        // Initial Page Load Animation
        window.onload = () => {
            loader.style.visibility = 'visible';
            loader.style.opacity = '1';
            setTimeout(() => {
                loader.style.opacity = '0';
                loader.style.visibility = 'hidden';
                formContainer.classList.add('content-visible');
            }, 1200);
        };

        function triggerLoader(text) {
            loaderText.textContent = text;
            loader.style.visibility = 'visible';
            loader.style.opacity = '1';
        }

        function hideLoader() {
            loader.style.opacity = '0';
            loader.style.visibility = 'hidden';
        }

        document.getElementById('create-agent-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const msg = document.getElementById('msg');
            msg.classList.add('hidden');
            
            // Start Loader
            triggerLoader("Creating Account & Sending Email...");

            const payload = {
                // ➕ ADDED: fullName to the payload
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                agentId: document.getElementById('agentId').value,
                phone: document.getElementById('phone').value,
                role: 'Agent'
            };

            try {
                const res = await fetch('/api/auth/register-agent', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                
                hideLoader();

                if(!res.ok) throw new Error(data.message);

                msg.className = "p-3 mb-4 rounded text-sm font-bold bg-green-100 text-green-700";
                msg.textContent = "✅ Agent Created! Credentials sent to email.";
                msg.classList.remove('hidden');
                e.target.reset();

            } catch (err) {
                hideLoader();
                msg.className = "p-3 mb-4 rounded text-sm font-bold bg-red-100 text-red-700";
                msg.textContent = "❌ " + err.message;
                msg.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>