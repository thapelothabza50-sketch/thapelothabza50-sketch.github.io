<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard | Recruitment Tracker</title>
    <link rel="icon" type="image/x-icon" href="Images/campus collective icon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        #form-modal { transition: transform 0.3s ease-in-out; transform: translateY(100%); z-index: 70; }
        #form-modal.open { transform: translateY(0); }
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.5s ease-out; visibility: hidden; opacity: 0;
        }
        .loader-ring {
            position: absolute; width: 120px; height: 120px;
            border: 3px solid transparent; border-top: 3px solid #2563eb;
            border-bottom: 3px solid #ff6600; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #sidebar {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: white; z-index: 100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 15px 0 30px rgba(0,0,0,0.05); padding: 25px;
        }
        #sidebar.open { left: 0; }
        .status-pill { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; }
    </style>
</head>
<body class="pb-24">

<div id="loader-overlay">
    <div class="relative flex items-center justify-center">
        <div class="loader-ring"></div>
        <img src="Images/Campus collective logo origin.jpg" alt="Logo" class="w-20 h-20 rounded-full">
    </div>
    <p id="loader-text" class="mt-6 text-blue-600 font-bold animate-pulse">Processing...</p>
</div>

<header class="bg-white border-b border-gray-100 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="p-2 text-xl">‚ò∞</button>
            <img src="Images/Campus collective logo origin.jpg" alt="Logo" class="w-8 h-8 rounded-full">
            <h1 class="text-xl font-black text-gray-800">Agent Portal</h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="agent-initials" class="w-8 h-8 bg-blue-600 text-white flex items-center justify-center rounded-full text-xs font-bold">..</div>
            <button onclick="logout()" class="text-red-500 font-bold text-xs uppercase">Logout</button>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 mt-6">
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
        <div class="card p-4 border-l-4 border-blue-500">
            <p class="text-gray-400 font-bold text-[10px] uppercase">Pending</p>
            <h2 id="pending-count" class="text-2xl font-black">0</h2>
        </div>
        <div class="card p-4 border-l-4 border-green-500">
            <p class="text-gray-400 font-bold text-[10px] uppercase">Approved</p>
            <h2 id="approved-count" class="text-2xl font-black text-green-500">0</h2>
        </div>
        <div class="card p-4 col-span-2 md:col-span-1 border-l-4 border-orange-500">
            <p class="text-gray-400 font-bold text-[10px] uppercase">Total Commission</p>
            <h2 id="total-commission" class="text-2xl font-black text-blue-600">R 0.00</h2>
        </div>
    </div>

    <div class="card overflow-hidden">
        <div class="p-5 border-b flex justify-between items-center bg-gray-50/50">
            <h3 class="font-bold text-gray-700">Recruit List</h3>
            <div class="flex gap-2">
                <button onclick="downloadPDF()" class="bg-red-50 text-red-600 px-3 py-2 rounded font-bold text-[10px] border border-red-100">EXPORT PDF</button>
                <button onclick="openAddForm()" class="hidden md:block bg-blue-600 text-white px-4 py-2 rounded font-bold text-[10px]">+ ADD NEW</button>
            </div>
        </div>

        <div class="hidden md:block">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-[10px] uppercase text-gray-400 font-bold">
                    <tr>
                        <th class="px-6 py-4">Student</th>
                        <th class="px-6 py-4">Accommodation</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="submissions-table" class="divide-y divide-gray-50 text-sm"></tbody>
            </table>
        </div>

        <div id="mobile-recruits-list" class="md:hidden divide-y divide-gray-100"></div>
    </div>
</main>

<button onclick="openAddForm()" class="md:hidden fixed bottom-6 right-6 w-16 h-16 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center z-40 text-3xl font-bold">+</button>

<div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-50" onclick="closeForm()"></div>
<div id="form-modal" class="fixed inset-x-0 bottom-0 md:inset-y-0 md:right-0 md:left-auto md:w-[450px] bg-white p-6 shadow-2xl overflow-y-auto rounded-t-3xl md:rounded-none">
    <div class="flex justify-between items-center mb-6">
        <h3 id="formTitle" class="text-xl font-black">Submit New Student</h3>
        <button onclick="closeForm()" class="text-3xl text-gray-400">&times;</button>
    </div>

    <form id="studentForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <input type="text" id="studentName" name="studentName" placeholder="Name" required class="p-4 border rounded-2xl bg-gray-50 w-full">
            <input type="text" id="studentSurname" name="studentSurname" placeholder="Surname" required class="p-4 border rounded-2xl bg-gray-50 w-full">
        </div>
        <input type="email" id="studentEmail" name="studentEmail" placeholder="Email Address" required class="w-full p-4 border rounded-2xl bg-gray-50">
        <input type="tel" id="studentPhone" name="studentPhone" placeholder="Phone (e.g. 012 345 6789)" required class="w-full p-4 border rounded-2xl bg-gray-50">
        
        <select name="accommodation" id="acc-select" required class="w-full p-4 border rounded-2xl bg-gray-50" onchange="checkOther(this)">
            <option value="" disabled selected>Select from listed properties...</option>
                <option value="Vuyani Student Accomodation">Vuyani Student Accomodation</option>
                <option value="Embizeni Student Accomodation (Matt)">Embizeni Student Accomodation (Matt)</option>
                <option value="Embizeni Student Accomodation (likazi 1)">Embizeni Student Accomodation (likazi 1)</option>
                <option value="Embizeni Student Accomodation (likaz 2)">Embizeni Student Accomodation (likaz 2)</option>
                <option value="Embizeni Student Accomodation (Entokozweni)">Embizeni Student Accomodation (Entokozweni)</option>
                <option value="View Inn Student accommodation">View Inn Student accommodation</option>
                <option value="Mashimula Student Accommodation (Likazi)">Mashimula Student Accommodation (Likazi)</option>
                <option value="Mashimula Student Accommodation (Entokozweni)">Mashimula Student Accommodation (Entokozweni)</option>
                <option value="Cecil Complex">Cecil Complex</option>
                <option value="Boniville Student Acc">Boniville Student Acc</option>
                <option value="Paballo Student Acc">Paballo Student Acc</option>
                <option value="EGP-holdings">EGP-holdings</option>
                <option value="not listed">Other (Not Listed Above)</option>
        </select>
        <input type="text" id="manual-acc" name="manualAccommodation" placeholder="Enter Name" class="w-full p-4 border border-blue-400 rounded-2xl hidden mt-2">

        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1">Move In Date</label>
        <input type="date" id="moveInDate" name="moveInDate" required class="w-full p-4 border rounded-2xl bg-gray-50">

        <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition mt-4">SUBMIT RECRUIT</button>
    </form>
</div>

<div id="sidebar">
    <div class="flex justify-between items-center mb-10">
        <h2 class="text-xl font-black text-blue-600">AGENT HUB</h2>
        <button onclick="toggleSidebar()" class="text-3xl">&times;</button>
    </div>

    <div class="mb-6 p-4 bg-blue-50 rounded-2xl border border-blue-100">
        <div class="flex items-center gap-3 mb-2">
            <div id="side-initials" class="w-10 h-10 bg-blue-600 text-white flex items-center justify-center rounded-full font-bold text-sm">..</div>
            <div>
                <p id="side-name" class="font-bold text-gray-800 leading-tight">Loading...</p>
                <p id="side-id" class="text-[10px] text-blue-600 font-mono">ID: ---</p>
            </div>
        </div>
    </div>

    <div class="space-y-2">
        <button onclick="toggleSection('personal-section')" class="w-full flex justify-between items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition font-bold text-gray-700 text-sm">
            <span>üë§ Edit Personal Details</span>
            <span class="text-gray-400">‚Ä∫</span>
        </button>

        <button id="bank-nav-btn" onclick="toggleSection('bank-section')" class="w-full flex justify-between items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition font-bold text-gray-700 text-sm">
            <span id="bank-btn-text">üè¶ Add Banking Details</span>
            <span class="text-gray-400">‚Ä∫</span>
        </button>
    </div>

    <hr class="my-6 border-gray-100">

    <div id="personal-section" class="hidden space-y-4 animate-in fade-in duration-300">
        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Update Profile</p>
        <form id="profileUpdateForm" class="space-y-3">
            <input type="text" name="fullName" id="edit-fullname" placeholder="Full Name" class="w-full p-3 border rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <input type="email" name="email" id="edit-email" placeholder="Email Address" class="w-full p-3 border rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <input type="tel" name="phone" id="edit-phone" placeholder="Phone Number" class="w-full p-3 border rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md active:scale-95">Update Profile</button>
        </form>
    </div>

    <div id="bank-section" class="hidden space-y-4 animate-in fade-in duration-300">
        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Settlement Account</p>
        <form id="bankForm" class="space-y-3">
            <input type="text" name="bankName" id="bnk-name" placeholder="Bank Name" required class="w-full p-3 border rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <input type="text" name="accHolder" id="bnk-holder" placeholder="Account Holder" required class="w-full p-3 border rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <input type="number" name="accNumber" id="bnk-num" placeholder="Account Number" required class="w-full p-3 border rounded-xl bg-white text-sm outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md active:scale-95">Save Banking</button>
        </form>
    </div>
</div>

<script>
    const API_URL = '/api/admin'; 
    const loader = document.getElementById('loader-overlay');
    let currentEditId = null; 
    let allRecruits = []; 

    function getToken() { return localStorage.getItem('jwtToken'); }

    // --- POPUP CONTROLS ---
    function openAddForm() {
        currentEditId = null;
        document.getElementById('studentForm').reset();
        document.getElementById('formTitle').innerText = "Submit New Student";
        document.getElementById('submitBtn').innerText = "SUBMIT RECRUIT";
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.getElementById('form-modal').classList.add('open');
    }
    function closeForm() {
        document.getElementById('modal-overlay').classList.add('hidden');
        document.getElementById('form-modal').classList.remove('open');
    }

    // --- DATA HANDLING ---
    async function fetchAgentData() {
        try {
            const response = await fetch(`${API_URL}/recruits`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            const data = await response.json();
            allRecruits = data; 
            renderUI(data);
            updateStats(data);
        } catch (err) { console.error(err); }
        finally { hideLoader(); }
    }

    function renderUI(recruits) {
        const tableBody = document.getElementById('submissions-table');
        const mobileList = document.getElementById('mobile-recruits-list');
        
        tableBody.innerHTML = recruits.map(r => `
            <tr>
                <td class="px-6 py-4 font-bold text-gray-800">${r.studentName} ${r.studentSurname}</td>
                <td class="px-6 py-4 text-gray-500">${r.accommodation}</td>
                <td class="px-6 py-4"><span class="status-pill ${r.status==='Approved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${r.status}</span></td>
                <td class="px-6 py-4 text-right">
                    <button onclick="editRecruit('${r._id}')" class="text-blue-600 font-bold mr-4">Edit</button>
                    <button onclick="deleteRecruit('${r._id}')" class="text-red-500 font-bold">Delete</button>
                </td>
            </tr>
        `).join('');

        mobileList.innerHTML = recruits.map(r => `
            <div class="p-5">
                <div class="flex justify-between items-start mb-2">
                    <div><p class="font-bold text-gray-800">${r.studentName} ${r.studentSurname}</p><p class="text-xs text-gray-400">${r.accommodation}</p></div>
                    <span class="status-pill ${r.status==='Approved'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">${r.status}</span>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <p class="font-black text-blue-600">R ${r.commissionEarned || 0}</p>
                    <div class="flex gap-4">
                        <button onclick="editRecruit('${r._id}')" class="bg-blue-50 text-blue-600 px-3 py-1 rounded font-bold text-sm">Edit</button>
                        <button onclick="deleteRecruit('${r._id}')" class="bg-red-50 text-red-500 px-3 py-1 rounded font-bold text-sm">Delete</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // --- CRUD OPERATIONS ---
    async function editRecruit(id) {
        const recruit = allRecruits.find(r => r._id === id); 
        if (!recruit) return;
        currentEditId = id;
        document.getElementById('studentName').value = recruit.studentName;
        document.getElementById('studentSurname').value = recruit.studentSurname;
        document.getElementById('studentEmail').value = recruit.studentEmail;
        document.getElementById('studentPhone').value = recruit.studentPhone;
        const accSelect = document.getElementById('acc-select');
        const manualInput = document.getElementById('manual-acc');
        let found = Array.from(accSelect.options).some(opt => opt.value === recruit.accommodation);
        if (found) { accSelect.value = recruit.accommodation; manualInput.classList.add('hidden'); } 
        else { accSelect.value = 'not listed'; manualInput.classList.remove('hidden'); manualInput.value = recruit.accommodation; }
        if (recruit.moveInDate) document.getElementById('moveInDate').value = recruit.moveInDate.split('T')[0];
        document.getElementById('formTitle').innerText = "Update Details";
        document.getElementById('submitBtn').innerText = "SAVE CHANGES";
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.getElementById('form-modal').classList.add('open');
    }

    async function deleteRecruit(id) {
        if(!confirm("Delete this student record?")) return;
        triggerLoader("Deleting...");
        try {
            const res = await fetch(`/api/auth/recruit/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            if(res.ok) fetchAgentData();
        } catch(e) { console.error(e); }
        finally { hideLoader(); }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        triggerLoader("Saving...");
        const formData = new FormData(e.target);
        const payload = Object.fromEntries(formData.entries());
        if (payload.accommodation === 'not listed') payload.accommodation = document.getElementById('manual-acc').value;
        const url = currentEditId ? `/api/auth/recruit/${currentEditId}` : `/api/auth/submit-recruit`;
        const method = currentEditId ? 'PUT' : 'POST';
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
                body: JSON.stringify(payload)
            });
            if (res.ok) { closeForm(); fetchAgentData(); }
        } catch (error) { console.error(error); }
        finally { hideLoader(); }
    }

    // --- PDF EXPORT ---
function downloadPDF() {
    if (allRecruits.length === 0) return alert("No data to export");
    
    // Get current Agent details from localStorage
    const user = JSON.parse(localStorage.getItem('userData') || '{}');
    const agentName = user.fullName || "Agent";
    const agentId = user.agentId || "N/A";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;

    // 1. Blue Border
    doc.setDrawColor(37, 99, 235);
    doc.setLineWidth(1.5);
    doc.rect(5, 5, pageWidth - 10, pageHeight - 10);

    // 2. Branded Header (Top Left)
    doc.setFont("helvetica", "bold");
    doc.setTextColor(37, 99, 235);
    doc.setFontSize(22);
    doc.text("Campus", 15, 22); 
    doc.setFontSize(10);
    doc.text("COLLECTIVE", 15, 27);

    // 3. Contact Info (Top Right)
    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text("Website: www.mycampuscollective.me", pageWidth - 80, 18);
    doc.text("Email: info@mycampuscollective.me", pageWidth - 80, 23);
    doc.text("Contact: 077 437 7288", pageWidth - 80, 28);

    // 4. Horizontal Line
    doc.setDrawColor(37, 99, 235);
    doc.line(12, 40, pageWidth - 12, 40);

    // 5. Report Title & Agent Details
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text("MY RECRUITMENT REPORT", 12, 50);
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Agent Name: ${agentName}`, 12, 57);
    doc.text(`Agent ID: ${agentId}`, 12, 63);
    doc.text(`Date Generated: ${new Date().toLocaleDateString()}`, pageWidth - 60, 63);

    // 6. Data Table
    const tableData = allRecruits.map(r => [
        `${r.studentName} ${r.studentSurname}`, 
        r.studentPhone || 'N/A',
        r.accommodation, 
        r.status, 
        new Date(r.createdAt || Date.now()).toLocaleDateString()
    ]);

    doc.autoTable({
        head: [['Student Name', 'Phone', 'Accommodation', 'Status', 'Date Applied']],
        body: tableData,
        startY: 70,
        theme: 'grid',
        headStyles: { fillColor: [37, 99, 235], textColor: [255, 255, 255], fontStyle: 'bold' },
        styles: { fontSize: 8, cellPadding: 3 },
        alternateRowStyles: { fillColor: [242, 247, 255] },
        margin: { left: 12, right: 12 }
    });

    // 7. Footer Page Numbers
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 15, { align: 'center' });
    }

    // 8. Save with custom filename: My recruits (Agent Name)
    doc.save(`My recruits (${agentName}).pdf`);
}

    // --- RESTORED PHONE MASKING ---
    function setupPhoneMask() {
        const phoneInput = document.getElementById('studentPhone');
        if(!phoneInput) return;
        phoneInput.addEventListener('input', function(e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : x[1] + ' ' + x[2] + (x[3] ? ' ' + x[3] : '');
        });
    }

    // --- UTILS ---
    function updateStats(recruits) {
        const pending = recruits.filter(r => r.status === 'Pending').length;
        const approved = recruits.filter(r => r.status === 'Approved').length;
        const total = recruits.reduce((sum, r) => sum + (r.commissionEarned || 0), 0);
        document.getElementById('pending-count').innerText = pending;
        document.getElementById('approved-count').innerText = approved;
        document.getElementById('total-commission').innerText = `R ${total.toFixed(2)}`;
    }
    function checkOther(s) { document.getElementById('manual-acc').classList.toggle('hidden', s.value !== 'not listed'); }
    function triggerLoader(t) { document.getElementById('loader-text').innerText = t; loader.style.visibility = 'visible'; loader.style.opacity = '1'; }
    function hideLoader() { loader.style.opacity = '0'; setTimeout(() => { loader.style.visibility = 'hidden'; }, 500); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
    function logout() { localStorage.clear(); window.location.href = 'agent login.html'; }
    
    // --- INACTIVITY TIMER ---
    let inactivityTimer;
    const resetTimer = () => {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        alert("Session expired due to inactivity. Please login again.");
        logout();
    }, 300000); // 5 minutes
    };
   
    function syncSidebarData() {
        const user = JSON.parse(localStorage.getItem('userData') || '{}');
        
        // Update Profile Displays
        document.getElementById('side-name').innerText = user.fullName || "Agent";
        document.getElementById('side-id').innerText = "ID: " + (user.agentId || "---");
        const initials = (user.fullName || "A").split(' ').map(n=>n[0]).join('').toUpperCase();
        document.getElementById('side-initials').innerText = initials.substring(0,2);
        document.getElementById('agent-initials').innerText = initials.substring(0,2);

        // Pre-fill Profile Form
        document.getElementById('edit-fullname').value = user.fullName || "";
        document.getElementById('edit-email').value = user.email || "";
        document.getElementById('edit-phone').value = user.phone || "";

        // Check for Banking Data
        const bankBtnText = document.getElementById('bank-btn-text');
        if (user.bankName) {
            bankBtnText.innerText = "üè¶ View / Edit Banking";
            // Pre-fill Banking Form
            document.getElementById('bnk-name').value = user.bankName || "";
            document.getElementById('bnk-holder').value = user.accHolder || "";
            document.getElementById('bnk-num').value = user.accNumber || "";
        } else {
            bankBtnText.innerText = "üè¶ Add Banking Details";
        }
    }
   

// Listen for user activity to reset the clock
window.onmousemove = resetTimer;
window.onkeydown = resetTimer;
window.onclick = resetTimer;
    window.onload = () => { 
        if(!getToken()) return logout();
        setupPhoneMask();
        fetchAgentData();
        syncSidebarData(); 
        resetTimer();
        document.getElementById('studentForm').addEventListener('submit', handleFormSubmit);
        
        // Handle Profile Updates
        document.getElementById('profileUpdateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        triggerLoader("Updating Profile...");
        const payload = Object.fromEntries(new FormData(e.target));
        
        try {
            const res = await fetch('/api/auth/update-profile', {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}` 
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                localStorage.setItem('userData', JSON.stringify(data.user));
                syncSidebarData();
                toggleSection('personal-section');
                alert("Profile Updated!");
            }
        } catch (error) { console.error(error); }
        finally { hideLoader(); }
    });
    // Handle banking details update.
    document.getElementById('bankForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        triggerLoader("Saving Banking...");
        const payload = Object.fromEntries(new FormData(e.target));
        
        try {
            const res = await fetch('/api/auth/update-banking', {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}` 
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                localStorage.setItem('userData', JSON.stringify(data.user));
                syncSidebarData();
                toggleSection('bank-section');
                alert("Banking Details Saved!");
            }
        } catch (error) { console.error(error); }
        finally { hideLoader(); }
    });
    
        
        const user = JSON.parse(localStorage.getItem('userData') || '{}');
        document.getElementById('side-name').innerText = user.fullName || "Agent";
        document.getElementById('side-id').innerText = "ID: " + (user.agentId || "---");
        const initials = (user.fullName || "A").split(' ').map(n=>n[0]).join('').toUpperCase();
        document.getElementById('agent-initials').innerText = initials.substring(0,2);
    };
</script>
</body>
</html>