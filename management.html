<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Management Dashboard | Campus Collective</title>
     <link rel="icon" type="image/x-icon" href="Images/campus collective icon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .logo-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 25px; }
        th { background-color: #f8fafc; text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; }

        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.8s ease-out, visibility 0.8s;
            visibility: hidden; opacity: 0;
        }
        .logo-container { position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        .loader-ring {
            position: absolute; width: 150px; height: 150px;
            border: 3px solid transparent; border-top: 3px solid #2563eb;
            border-bottom: 3px solid #ff6600; border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #payment-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
    </style>
</head>
<body class="p-6">

<div id="loader-overlay">
    <div class="logo-container">
        <div class="loader-ring"></div>
        <img src="Images/Campus collective logo origin.jpg" alt="Logo" class="w-24 h-24 rounded-full z-10 shadow-2xl">
    </div>
    <p id="loader-text" class="mt-8 text-blue-600 font-black uppercase tracking-widest animate-pulse">Processing...</p>
</div>

<div id="payment-modal">
    <div class="bg-white p-8 rounded-2xl w-[500px] shadow-2xl relative border-t-8 border-blue-600">
        <button onclick="closePaymentModal()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-black">&times;</button>
        <h2 class="text-2xl font-black text-blue-600 mb-4 uppercase text-center">Agent Payout Portal</h2>
        <div id="payment-content" class="space-y-4"></div>
    </div>
</div>

<div class="container">
    <div class="logo-area">
        <div class="flex items-center gap-4">
            <img src="Images/Campus collective logo origin.jpg" alt="Logo" class="w-16 h-16 rounded-full object-cover">
            <h1 class="text-2xl font-black text-gray-800 uppercase tracking-tight">Management Command Center</h1>
        </div>
        <div class="flex gap-4">
    <button onclick="triggerLoader('Syncing Data...', 1200).then(()=>location.reload())" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold border hover:bg-gray-200 transition">ğŸ”„ Refresh</button>
    
    <button onclick="window.location.href='water-management.html'" class="bg-cyan-100 text-cyan-700 px-4 py-2 rounded-lg font-bold border border-cyan-300 hover:bg-cyan-200 transition">ğŸ’§ Water Supply</button>
    
    <button onclick="openCalculator()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-bold border border-blue-300 hover:bg-blue-200 transition">â• Commission Calcs</button>
    <button onclick="logout()" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700 transition">Secure Logout</button>
</div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div class="bg-blue-600 p-6 rounded-xl text-white shadow-lg">
            <h3 class="text-lg font-semibold opacity-80">Total Revenue</h3>
            <p id="stat-revenue" class="text-3xl font-bold">R 0.00</p>
        </div>
        <div class="bg-emerald-600 p-6 rounded-xl text-white shadow-lg">
            <h3 class="text-lg font-semibold opacity-80">Total Orders</h3>
            <p id="stat-orders" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-purple-600 p-6 rounded-xl text-white shadow-lg">
            <h3 class="text-lg font-semibold opacity-80">Escrow Held</h3>
            <p id="escrow-total" class="text-3xl font-bold">R 0.00</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl text-white shadow-lg">
            <h3 class="text-lg font-semibold opacity-80">Personnel</h3>
            <p id="stat-users" class="text-3xl font-bold">0</p>
        </div>
    </div>

    <div class="mb-4 flex justify-between">
        <input type="text" id="globalSearch" onkeyup="handleGlobalSearch()" placeholder="Search..." class="w-1/3 p-2 border-2 border-blue-100 rounded-lg outline-none text-sm shadow-sm">
        <button onclick="printAllRecruitsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-green-700 transition">ğŸ“ƒ Print Master Recruit List</button>
    </div>

    <div class="flex justify-between items-center mb-6 border-b border-gray-200">
        <div class="flex gap-8">
            <button onclick="switchTab('agents')" id="tab-agents" class="tab-active py-2 px-4">Internal Agents</button>
            <button onclick="switchTab('profiles')" id="tab-profiles" class="py-2 px-4">Marketplace Sellers</button>
            <button onclick="switchTab('recruits')" id="tab-recruits" class="py-2 px-4">Student Recruits</button>
            <button onclick="switchTab('escrow')" id="tab-escrow" class="py-2 px-4">Escrow Tracker</button>
            <button onclick="switchTab('residences')" id="tab-residences" class="py-2 px-4">Residence Alerts</button>
        </div>
        <button onclick="addNewAccount()" class="bg-black text-white px-4 py-2 rounded-lg font-bold mb-2 hover:bg-gray-800 transition">+Add New Agent</button>
    </div>

    <div id="section-agents" class="space-y-6">
        <div class="bg-white rounded-lg overflow-hidden border border-gray-200">
            <table class="w-full border-collapse">
                <thead>
                    <tr><th>Agent Name</th><th>Agent ID</th><th>Contact</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="agent-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section-profiles" class="hidden space-y-6">
        <div class="bg-white rounded-lg overflow-hidden border border-gray-200">
            <table class="w-full border-collapse">
                <thead>
                    <tr><th>Seller / Business</th><th>Contact info</th><th>Role</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody id="profile-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section-recruits" class="hidden space-y-6">
        <div class="flex gap-4 items-center bg-blue-50 p-4 rounded-xl border border-blue-100">
            <span class="text-sm font-bold text-blue-800">Print Accommodation:</span>
            <select id="acc-filter" class="p-2 border rounded-lg text-sm bg-white"></select>
            <button onclick="printAccPDF()" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs hover:bg-blue-700 transition">Print List</button>
        </div>
        <div class="bg-white rounded-lg overflow-hidden border border-gray-200">
            <table class="w-full border-collapse">
                <thead>
                 <tr>
                    <th>Student</th>
                    <th>Phone</th>
                    <th>Accommodation</th>
                    <th>Agent</th>
                    <th>Date Applied</th>
                    <th class="p-3">Move-in Date</th>
                     <th class="p-3">Status</th>
                     <th>Control</th>
                    
                    </tr>
                </thead> 
                <tbody id="recruit-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section-escrow" class="hidden space-y-6">
        <div class="bg-white rounded-lg overflow-hidden border border-gray-200">
            <table class="w-full border-collapse">
                <thead>
                    <tr><th>Order ID</th><th>Customer</th><th>Amount</th><th>Escrow Status</th><th>Date</th><th>Control</th></tr>
                </thead>
                <tbody id="escrow-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="section-residences" class="hidden space-y-6">
        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
            <h2 class="text-xl font-black text-blue-600 mb-4 uppercase">ğŸš€ Create Residence Announcement</h2>
            <form id="residenceForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="resName" placeholder="Residence Name" class="p-3 border rounded-xl" required>
                <input type="text" id="resLocation" placeholder="Location" class="p-3 border rounded-xl" required>
                <input type="text" id="resRooms" placeholder="Room Types (e.g. Single, Double)" class="p-3 border rounded-xl">
                <input type="text" id="resFunding" placeholder="Funding Info" class="p-3 border rounded-xl">
                <input type="text" id="resSlug" placeholder="Residence URL Slug" class="p-3 border rounded-xl">
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Upload Property Image</label>
                    <input type="file" id="resImage" class="p-2 border rounded-xl text-sm" accept="image/*" required>
                </div>
                
                <div class="md:col-span-2 flex gap-3 mt-4">
                    <button type="button" onclick="handleResidence('draft')" class="bg-gray-500 text-white px-6 py-3 rounded-xl font-bold uppercase text-sm shadow-md hover:bg-gray-600 transition">Save Draft</button>
                    <button type="button" onclick="handleResidence('send')" class="bg-yellow-500 text-black px-6 py-3 rounded-xl font-bold uppercase text-sm shadow-md hover:bg-yellow-600 transition">Send To All Agents</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="calc-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[2000]">
    <div class="bg-white p-8 rounded-3xl w-96 shadow-2xl">
        <h2 class="text-2xl font-black mb-6 flex items-center gap-2">$ Commission <span class="text-blue-600">Pro</span></h2>
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Calculation Type</label>
                <select id="calc-mode" onchange="toggleManualInput()" class="w-full p-3 bg-gray-50 border rounded-xl font-bold">
                    <option value="seller">Seller Marketplace (10%)</option>
                    <option value="agent">Internal Agent (R250/unit)</option>
                    <option value="manual">Manual Custom Payout</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Item/Unit Price</label>
                <input type="number" id="calc-price" oninput="runCalc()" placeholder="0.00" class="w-full p-3 bg-gray-50 border rounded-xl font-bold">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Quantity/Units</label>
                <input type="number" id="calc-qty" oninput="runCalc()" value="1" class="w-full p-3 bg-gray-50 border rounded-xl font-bold">
            </div>
            <div id="manual-val-div" class="hidden">
                <label class="block text-xs font-bold text-blue-400 uppercase mb-1">Custom Payout per Unit</label>
                <input type="number" id="calc-manual-val" oninput="runCalc()" placeholder="0.00" class="w-full p-3 bg-blue-50 border border-blue-200 rounded-xl font-bold text-blue-700">
            </div>
            <div class="bg-gray-900 p-5 rounded-2xl text-white space-y-2 mt-4">
                <div class="flex justify-between border-b border-white/10 pb-2">
                    <span class="text-xs text-gray-400">Campus Admin:</span>
                    <span id="calc-admin" class="font-bold text-blue-400">R 0.00</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-xs text-gray-400">Partner Payout:</span>
                    <span id="calc-partner" class="font-bold text-green-400">R 0.00</span>
                </div>
            </div>
        </div>
        <button onclick="closeCalculator()" class="w-full mt-6 bg-gray-100 py-3 rounded-xl font-bold text-gray-600 hover:bg-gray-200 transition uppercase text-sm">Close Tool</button>
    </div>
</div>

<script>

Â  Â  const API_BASE_URL = '/api/admin';
Â  Â  const API_AUTH_URL = '/api/auth';
Â  Â  const token = localStorage.getItem('jwtToken');
Â  Â  const loader = document.getElementById('loader-overlay');
Â  Â  const loaderText = document.getElementById('loader-text');
Â  Â  
Â  Â  let allRecruits = [];
Â  Â  let allUsers = [];

Â  Â  // --- NEW FIX 1: 5-MINUTE SECURITY TIMEOUT ---
Â  Â  let inactivityTimer;
Â  Â  const resetTimer = () => {
Â  Â  Â  Â  clearTimeout(inactivityTimer);
Â  Â  Â  Â  inactivityTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  alert("Session expired due to 5 minutes of inactivity.");
Â  Â  Â  Â  Â  Â  logout();
Â  Â  Â  Â  }, 300000); 
Â  Â  };
Â  Â  window.onmousemove = resetTimer;
Â  Â  window.onkeydown = resetTimer;

Â  Â  function triggerLoader(text, duration = 1200) {
Â  Â  Â  Â  loaderText.textContent = text;
Â  Â  Â  Â  loader.style.visibility = 'visible'; loader.style.opacity = '1';
Â  Â  Â  Â  return new Promise(resolve => setTimeout(() => {
Â  Â  Â  Â  Â  Â  loader.style.opacity = '0'; loader.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  setTimeout(resolve, 500);
Â  Â  Â  Â  }, duration));
Â  Â  }

Â  Â  function switchTab(tab) {
Â  Â  Â  Â  ['profiles', 'recruits', 'escrow', 'agents', 'residences'].forEach(t => {
Â  Â  Â  Â  Â  Â  document.getElementById('section-' + t).classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('tab-' + t).classList.remove('tab-active');
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('section-' + tab).classList.remove('hidden');
Â  Â  Â  Â  document.getElementById('tab-' + tab).classList.add('tab-active');

Â  Â  Â  Â  if(tab === 'profiles' || tab === 'agents') fetchProfiles();
Â  Â  Â  Â  if(tab === 'recruits') fetchRecruits();
Â  Â  Â  Â  // if(tab === 'escrow') fetchEscrowOrders(); // Restored from original
Â  Â  }

Â  Â  async function handleResidence(mode) {
Â  Â  Â  Â  const fileInput = document.getElementById('resImage');
Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  
Â  Â  Â  Â  if (fileInput.files[0]) formData.append('resImage', fileInput.files[0]);
Â  Â  Â  Â  formData.append('resName', document.getElementById('resName').value);
Â  Â  Â  Â  formData.append('location', document.getElementById('resLocation').value);
Â  Â  Â  Â  formData.append('rooms', document.getElementById('resRooms').value);
Â  Â  Â  Â  formData.append('funding', document.getElementById('resFunding').value);
Â  Â  Â  Â  formData.append('resSlug', document.getElementById('resSlug').value);
Â  Â  Â  Â  formData.append('mode', mode);

Â  Â  Â  Â  await triggerLoader(mode === 'send' ? "Broadcasting Emails..." : "Saving Draft...");
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_AUTH_URL}/announce-residence`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${token}` },
Â  Â  Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  alert(data.message);
Â  Â  Â  Â  } catch (err) { alert("Error: " + err.message); }
Â  Â  }

Â  Â  async function fetchProfiles() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_BASE_URL}/profiles`, { headers: { 'Authorization': `Bearer ${token}` } });
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  allUsers = data;
Â  Â  Â  Â  Â  Â  renderAllUsers(data);
Â  Â  Â  Â  Â  Â  document.getElementById('stat-users').innerText = data.length;
Â  Â  Â  Â  } catch (e) { console.error(e); }
Â  Â  }
Â  Â  

Â  Â  function renderAllUsers(users) {
Â  Â  Â  Â  const agentBody = document.getElementById('agent-table-body');
Â  Â  Â  Â  const sellerBody = document.getElementById('profile-table-body');
Â  Â  Â  Â  
Â  Â  Â  Â  const agents = users.filter(u => u.role === 'Agent' || u.role === 'agent');
Â  Â  Â  Â  const sellers = users.filter(u => u.role !== 'Agent' && u.role !== 'agent');

Â  Â  Â  Â  agentBody.innerHTML = agents.map(u => `
Â  Â  Â  Â  Â  Â  <tr class="hover:bg-blue-50 cursor-pointer" onclick="openAgentPayment('${u._id}')">
Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${u.fullName}</b><br><small class="text-gray-400">${u.email}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="text-blue-600 font-mono font-bold">${u.agentId || '---'}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${u.phone || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="${u.status === 'active' ? 'text-green-600' : 'text-red-600'} font-bold uppercase text-xs">${u.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); toggleLock('${u._id}', '${u.status}')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs font-bold border">LOCK/UNLOCK</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); deleteAccount('${u._id}', 'Agent')" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold border border-red-200">DELETE</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`).join('');

Â  Â  Â  Â  sellerBody.innerHTML = sellers.map(u => `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${u.businessName || u.fullName}</b><br><small>${u.email}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${u.phone || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${u.role}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="${u.status === 'active' ? 'text-green-600' : 'text-red-600'} font-bold uppercase text-xs">${u.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="toggleLock('${u._id}', '${u.status}')" class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs font-bold border mr-2">LOCK/UNLOCK</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteAccount('${u._id}', 'Seller')" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold border">DELETE</button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`).join('');
Â  Â  }

Â  Â  async function fetchRecruits() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch('/api/auth/all-recruits', { 
Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${token}` }
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  
Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  allRecruits = data;

Â  Â  Â  Â  Â  Â  // --- NEW FIX 2: POPULATE ACC DROPDOWN FOR PDF FILTER ---
Â  Â  Â  Â  Â  Â  const accFilter = document.getElementById('acc-filter');
Â  Â  Â  Â  Â  Â  if (accFilter) {
Â  Â  Â  Â  Â  Â  Â  Â  const uniqueAccs = [...new Set(data.map(r => r.accommodation))];
Â  Â  Â  Â  Â  Â  Â  Â  accFilter.innerHTML = '<option value="">Select Accommodation...</option>' + 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniqueAccs.map(acc => `<option value="${acc}">${acc}</option>`).join('');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  renderRecruits(data);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Failed to fetch recruits:", data.message);
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Error fetching recruits:", err);
Â  Â  }
}

Â  Â  function renderRecruits(recruits) {
Â  Â  const body = document.getElementById('recruit-table-body');
Â  Â  body.innerHTML = recruits.map(r => {
Â  Â  Â  Â  let agentName = "System/Direct";
Â  Â  Â  Â  if (r.agent && r.agent.fullName) agentName = r.agent.fullName;
Â  Â  Â  Â  else if (typeof r.agent === 'string') {
Â  Â  Â  Â  Â  Â  const found = allUsers.find(u => u._id === r.agent);
Â  Â  Â  Â  Â  Â  if (found) agentName = found.fullName;
Â  Â  Â  Â  }

Â  Â  Â  Â  return `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td><b>${r.studentName} ${r.studentSurname}</b><br><small>${r.studentEmail}</small></td>
Â  Â  Â  Â  Â  Â  <td class="text-xs font-mono">${r.studentPhone || 'N/A'}</td> 
Â  Â  Â  Â  Â  Â  <td>${r.accommodation}</td>
Â  Â  Â  Â  Â  Â  <td class="text-blue-600 font-bold">${agentName}</td>
Â  Â  Â  Â  Â  Â  <td>${new Date(r.createdAt).toLocaleDateString()}</td>
Â  Â  Â  Â  Â  Â  <td>${new Date(r.moveInDate).toLocaleDateString()}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-2 py-1 rounded text-[10px] font-black uppercase ${r.status === 'Approved' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.status}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="updateRecruitStatus('${r._id}', this.value)" class="text-xs p-1 border rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Update...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Approved">Approve</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Cancelled">Cancel</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pending..">Pending</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="deleteRecruit('${r._id}')" class="bg-red-50 text-red-600 p-1.5 rounded hover:bg-red-600 hover:text-white transition shadow-sm border border-red-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>`;
Â  Â  }).join('');
}


Â  Â function printAllRecruitsPDF() {
Â  Â  const { jsPDF } = window.jspdf;
Â  Â  const doc = new jsPDF();
Â  Â  const pageWidth = doc.internal.pageSize.width;
Â  Â  const pageHeight = doc.internal.pageSize.height;

Â  Â  doc.setDrawColor(37, 99, 235);
Â  Â  doc.setLineWidth(1.5);
Â  Â  doc.rect(5, 5, pageWidth - 10, pageHeight - 10);

Â  Â  doc.setFont("helvetica", "bold");
Â  Â  doc.setTextColor(37, 99, 235);
Â  Â  doc.setFontSize(22);
Â  Â  doc.text("Campus", 40, 22); 
Â  Â  doc.setFontSize(10);
Â  Â  doc.text("COLLECTIVE", 40, 27);

Â  Â  doc.setFontSize(8);
Â  Â  doc.setTextColor(100);
Â  Â  doc.text("Website: www.mycampuscollective.me", pageWidth - 80, 18);
Â  Â  doc.text("Email: info@mycampuscollective.me", pageWidth - 80, 23);
Â  Â  doc.text("Contact: 077 437 7288", pageWidth - 80, 28);

Â  Â  doc.setDrawColor(37, 99, 235);
Â  Â  doc.line(12, 40, pageWidth - 12, 40);

Â  Â  doc.setFontSize(14);
Â  Â  doc.setTextColor(0);
Â  Â  doc.text("MASTER RECRUITMENT REPORT", 12, 50);

Â  Â  const getAgentName = (r) => {
Â  Â  Â  Â  if (r.agent && r.agent.fullName) return r.agent.fullName;
Â  Â  Â  Â  const found = allUsers.find(u => u._id === (r.agent?._id || r.agent));
Â  Â  Â  Â  return found ? found.fullName : "Direct/System";
Â  Â  };

Â  Â  const groupedRecruits = [...allRecruits].sort((a, b) => 
Â  Â  Â  Â  getAgentName(a).localeCompare(getAgentName(b))
Â  Â  );

Â  Â  const rows = groupedRecruits.map(r => [
Â  Â  Â  Â  `${r.studentName} ${r.studentSurname}`,
Â  Â  Â  Â  r.studentPhone || 'N/A',
Â  Â  Â  Â  r.accommodation,
Â  Â  Â  Â  getAgentName(r),
Â  Â  Â  Â  r.status,
Â  Â  Â  Â  new Date(r.createdAt).toLocaleDateString()
Â  Â  ]);

Â  Â  doc.autoTable({
Â  Â  Â  Â  head: [['Student', 'Phone', 'Accommodation', 'Agent', 'Status', 'Date']],
Â  Â  Â  Â  body: rows,
Â  Â  Â  Â  startY: 55,
Â  Â  Â  Â  theme: 'grid',
Â  Â  Â  Â  headStyles: { fillColor: [37, 99, 235], textColor: [255, 255, 255] },
Â  Â  Â  Â  styles: { fontSize: 8, cellPadding: 3 },
Â  Â  Â  Â  alternateRowStyles: { fillColor: [242, 247, 255] },
Â  Â  Â  Â  margin: { left: 12, right: 12 }
Â  Â  });

Â  Â  doc.save('Campus_Collective_Master_Recruits.pdf');
}

function printAccPDF() {
Â  Â  const val = document.getElementById('acc-filter').value;
Â  Â  if (!val) {
Â  Â  Â  Â  alert("Please select an accommodation first");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const { jsPDF } = window.jspdf;
Â  Â  const doc = new jsPDF();

Â  Â  const filtered = allRecruits.filter(r => r.accommodation === val);

Â  Â  const getAgentName = (r) => {
Â  Â  Â  Â  if (r.agent && r.agent.fullName) return r.agent.fullName;
Â  Â  Â  Â  const found = allUsers.find(u => u._id === (r.agent?._id || r.agent));
Â  Â  Â  Â  return found ? found.fullName : "Direct/System";
Â  Â  };

Â  Â  const rows = filtered.map(r => [
Â  Â  Â  Â  `${r.studentName} ${r.studentSurname}`,
Â  Â  Â  Â  r.studentPhone || 'N/A',
Â  Â  Â  Â  getAgentName(r),
Â  Â  Â  Â  r.status,
Â  Â  Â  Â  new Date(r.createdAt).toLocaleDateString()
Â  Â  ]);

Â  Â  doc.autoTable({
Â  Â  Â  Â  head: [['Student', 'Phone', 'Agent', 'Status', 'Date Applied']],
Â  Â  Â  Â  body: rows,
Â  Â  Â  Â  startY: 20,
Â  Â  Â  Â  theme: 'grid',
Â  Â  Â  Â  headStyles: { fillColor: [37, 99, 235], textColor: [255, 255, 255] },
Â  Â  Â  Â  margin: { left: 12, right: 12 }
Â  Â  });

Â  Â  doc.save(`Recruits_Report_${val.replace(/\s+/g, '_')}.pdf`);
}

Â  Â  function printAgentPDF(agentName, agentId) {
Â  Â  Â  Â  const filtered = allRecruits.filter(r => (r.agent && r.agent._id === agentId) || (r.agent === agentId));
Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  const doc = new jsPDF();
Â  Â  Â  Â  doc.text(`RECRUITMENT REPORT: ${agentName}`, 14, 20);
Â  Â  Â  Â  const rows = filtered.map(r => [`${r.studentName} ${r.studentSurname}`, r.accommodation, r.status]);
Â  Â  Â  Â  doc.autoTable({ head: [['Student', 'Accommodation', 'Status']], body: rows, startY: 25 });
Â  Â  Â  Â  doc.save(`Agent_${agentName}.pdf`);
Â  Â  }

Â  Â  function openAgentPayment(userId) {
Â  Â  Â  Â  const agent = allUsers.find(u => u._id === userId);
Â  Â  Â  Â  if(!agent) return;

Â  Â  Â  Â  const agentRecruits = allRecruits.filter(r => ((r.agent && r.agent._id === userId) || (r.agent === userId)) && r.status === 'Approved');
Â  Â  Â  Â  const totalPayout = agentRecruits.reduce((sum, r) => sum + (parseFloat(r.commissionEarned) || 0), 0);

Â  Â  Â  Â  const modal = document.getElementById('payment-modal');
Â  Â  Â  Â  const content = document.getElementById('payment-content');
Â  Â  Â  Â  const bank = agent.banking || {};

Â  Â  Â  Â  content.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="bg-gray-100 p-4 rounded-xl border">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bold text-lg">${agent.fullName}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-blue-600 font-mono">${agent.agentId || 'ID: ---'}</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10px] font-bold text-blue-400 uppercase">Settlement Banking Details</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2 text-xs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><b>Bank:</b> ${bank.bankName || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><b>Acc Holder:</b> ${bank.accHolder || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><b>Acc Num:</b> ${bank.accNumber || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-emerald-600"><b>Phone:</b> ${bank.bankPhone || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center py-4">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-black text-gray-500 uppercase text-xs">Total Due for Payout:</p>
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-4xl font-black text-green-600">R ${totalPayout.toFixed(2)}</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="payWithPaystack('${agent.email}', ${totalPayout})" 
Â  Â  Â  Â  Â  Â  Â  Â  class="w-full bg-blue-600 text-white font-black py-4 rounded-xl hover:bg-blue-700 shadow-lg transition uppercase">
Â  Â  Â  Â  Â  Â  Â  Â  Authorize Bank Payout
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button onclick="printAgentPDF('${agent.fullName}', '${agent._id}')" class="w-full text-gray-400 text-xs uppercase font-bold hover:text-gray-800 transition">îå¡˜ Generate Report PDF</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  }

Â  Â  function closePaymentModal() { document.getElementById('payment-modal').style.display = 'none'; }

Â  Â  function payWithPaystack(email, amount) {
Â  Â  Â  Â  if(amount <= 0) { alert("Balance is zero."); return; }
Â  Â  Â  Â  const handler = PaystackPop.setup({
Â  Â  Â  Â  Â  Â  key: 'pk_test_xxxxxxxxxxxxxxxxxxxxxxxx', 
Â  Â  Â  Â  Â  Â  email: email,
Â  Â  Â  Â  Â  Â  amount: amount * 100,
Â  Â  Â  Â  Â  Â  currency: "ZAR",
Â  Â  Â  Â  Â  Â  callback: function(response) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Success! Reference: ' + response.reference);
Â  Â  Â  Â  Â  Â  Â  Â  closePaymentModal();
Â  Â  Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  handler.openIframe();
Â  Â  }

Â  Â  async function updateRecruitStatus(id, status) {
Â  Â  Â  Â  if(!status) return;
Â  Â  Â  Â  let commissionAmount = 0;
Â  Â  Â  Â  if(status === 'Approved') {
Â  Â  Â  Â  Â  Â  const val = prompt("Enter Commission Amount:", "250");
Â  Â  Â  Â  Â  Â  if(val === null) return;
Â  Â  Â  Â  Â  Â  commissionAmount = parseFloat(val) || 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  await triggerLoader("Updating...");
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await fetch(`${API_BASE_URL}/approve-recruit/${id}`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ status, commissionAmount })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  fetchRecruits();
Â  Â  Â  Â  } catch (e) { console.error(e); }
Â  Â  }

async function toggleLock(userId, currentStatus) {
Â  Â  const newStatus = currentStatus === 'active' ? 'locked' : 'active';
Â  Â  await triggerLoader(newStatus === 'locked' ? "Locking..." : "Unlocking...");

Â  Â  try {
Â  Â  Â  Â  const response = await fetch('/api/admin/toggle-lock', {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 
Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ userId, status: newStatus })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  alert(`Account ${newStatus} successfully`);
Â  Â  Â  Â  Â  Â  location.reload(); 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error("Failed to update status");
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  alert(err.message);
Â  Â  }
}

async function deleteAccount(userId) {
Â  Â  if (!confirm("Are you sure you want to PERMANENTLY delete this account?")) return;

Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`/api/admin/delete-user/${userId}`, {
Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  headers: { 
Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  alert(data.message);
Â  Â  Â  Â  Â  Â  location.reload(); 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert(data.message);
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Delete Error:", err);
Â  Â  }
}

async function deleteRecruit(recruitId) {
Â  Â  if (!confirm("Delete this student recruit?")) return;
Â  Â  await triggerLoader("Deleting Recruit...");

Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`/api/admin/delete-recruit/${recruitId}`, {
Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${localStorage.getItem('jwtToken')}` }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  alert("Recruit removed");
Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  Â  alert("Error deleting recruit");
Â  Â  }
}
Â  Â  function handleGlobalSearch() {
Â  Â  Â  Â  const query = document.getElementById('globalSearch').value.toLowerCase();
Â  Â  Â  Â  const rows = document.querySelectorAll('tbody tr');
Â  Â  Â  Â  rows.forEach(row => row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none');
Â  Â  }

Â  Â  function openCalculator() { document.getElementById('calc-modal').classList.remove('hidden'); }
Â  Â  function closeCalculator() { document.getElementById('calc-modal').classList.add('hidden'); }
Â  Â  function toggleManualInput() { 
Â  Â  Â  Â  const mode = document.getElementById('calc-mode').value;
Â  Â  Â  Â  document.getElementById('manual-val-div').classList.toggle('hidden', mode !== 'manual');
Â  Â  Â  Â  runCalc();
Â  Â  }
Â  Â  function runCalc() {
Â  Â  Â  Â  const mode = document.getElementById('calc-mode').value;
Â  Â  Â  Â  const price = parseFloat(document.getElementById('calc-price').value) || 0;
Â  Â  Â  Â  const qty = parseFloat(document.getElementById('calc-qty').value) || 1;
Â  Â  Â  Â  const manualVal = parseFloat(document.getElementById('calc-manual-val').value) || 0;
Â  Â  Â  Â  let admin = 0, partner = 0;
Â  Â  Â  Â  if (mode === 'seller') { admin = (price * qty) * 0.10; partner = (price * qty) - admin; }
Â  Â  Â  Â  else if (mode === 'agent') { admin = price * qty; partner = 250 * qty; }
Â  Â  Â  Â  else { partner = manualVal * qty; admin = (price * qty) - partner; }
Â  Â  Â  Â  document.getElementById('calc-admin').innerText = 'R ' + admin.toFixed(2);
Â  Â  Â  Â  document.getElementById('calc-partner').innerText = 'R ' + partner.toFixed(2);
Â  Â  }

Â  Â  async function addNewAccount() { await triggerLoader("Redirecting..."); window.location.href = 'Admin-register-agent.html'; }
Â  Â  async function logout() { await triggerLoader("Ending Session..."); localStorage.clear(); window.location.href = 'Admin.html'; }

Â  Â  // --- NEW FIX 3: ASYNC INITIALIZATION TO ENSURE DATA LOADS ---
Â  Â  window.onload = async () => { 
Â  Â  Â  Â  if(!token) { 
Â  Â  Â  Â  Â  Â  window.location.href = 'Admin.html'; 
Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  // Load both datasets before hiding the startup screen
Â  Â  Â  Â  Â  Â  await Promise.all([fetchProfiles(), fetchRecruits()]); 
Â  Â  Â  Â  Â  Â  resetTimer(); // Start inactivity clock
Â  Â  Â  Â  } 
Â  Â  };
Â  Â  const API_URL = '/api/auth/water'; 
Â  Â  const token = localStorage.getItem('jwtToken'); // Fixed to match management.html

Â  Â  async function loadSummary() {
Â  Â  Â  Â  if(!token) return window.location.href = 'Admin.html';

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_URL}/summary`, {
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${token}` } // Fixed Header
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dispQty').innerText = `${data.currentMonth.totalQty.toLocaleString()} L`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dispSpend').innerText = `R ${data.currentMonth.totalSpend.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const trendEl = document.getElementById('dispTrend');
Â  Â  Â  Â  Â  Â  Â  Â  trendEl.innerText = data.trend;
Â  Â  Â  Â  Â  Â  Â  Â  trendEl.className = `text-lg font-bold ${data.trendColor}`;

Â  Â  Â  Â  Â  Â  Â  Â  const body = document.getElementById('logBody');
Â  Â  Â  Â  Â  Â  Â  Â  body.innerHTML = data.logs.map(log => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="hover:bg-gray-50 border-b last:border-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 font-medium">${new Date(log.date).toLocaleDateString()}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4">${log.truckQuantity} L</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-4 font-bold">R ${log.totalCost.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  window.allLogs = data.logs; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error("Failed to load water data", err);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  document.getElementById('waterForm').addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  date: document.getElementById('date').value,
Â  Â  Â  Â  Â  Â  truckQuantity: Number(document.getElementById('qty').value),
Â  Â  Â  Â  Â  Â  pricePerUnit: Number(document.getElementById('price').value)
Â  Â  Â  Â  };

Â  Â  Â  Â  const res = await fetch(`${API_URL}/add`, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 
Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json', 
Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${token}` // Fixed Header
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });

Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  alert('Delivery Logged Successfully!');
Â  Â  Â  Â  Â  Â  document.getElementById('waterForm').reset();
Â  Â  Â  Â  Â  Â  loadSummary();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const err = await res.json();
Â  Â  Â  Â  Â  Â  alert('Error: ' + err.message);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  function generatePDF() {
Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  const doc = new jsPDF();

Â  Â  Â  Â  doc.setFontSize(18);
Â  Â  Â  Â  doc.setTextColor(30, 64, 175);
Â  Â  Â  Â  doc.text("Campus Collective: Water Supply Report", 14, 20);
Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  doc.setTextColor(100);
Â  Â  Â  Â  doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 28);

Â  Â  Â  Â  const tableData = window.allLogs.map(log => [
Â  Â  Â  Â  Â  Â  new Date(log.date).toLocaleDateString(),
Â  Â  Â  Â  Â  Â  `${log.truckQuantity} L`,
Â  Â  Â  Â  Â  Â  `R ${log.totalCost.toFixed(2)}`
Â  Â  Â  Â  ]);

Â  Â  Â  Â  doc.autoTable({
Â  Â  Â  Â  Â  Â  startY: 35,
Â  Â  Â  Â  Â  Â  head: [['Date', 'Quantity (Liters)', 'Total Cost']],
Â  Â  Â  Â  Â  Â  body: tableData,
Â  Â  Â  Â  Â  Â  theme: 'striped',
Â  Â  Â  Â  Â  Â  headStyles: { fillColor: [30, 64, 175] }
Â  Â  Â  Â  });

Â  Â  Â  Â  doc.save(`Water_Supply_Report_${new Date().toISOString().split('T')[0]}.pdf`);
Â  Â  }

Â  Â  // Initial Load
Â  Â  loadSummary();
</script>


</body>
</html>