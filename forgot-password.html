<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Campus Collective</title>
    <link rel="icon" type="image/x-icon" href="Images/campus collective icon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .hidden-strict { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-xl shadow-2xl">
        <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white">Password Recovery</h2>
        <p class="text-center text-gray-600 dark:text-gray-400" id="flow-status">
            Step 1: Enter your email to receive a confirmation code.
        </p>
        
        <div id="message-area" class="hidden p-3 text-sm rounded-lg" role="alert"></div>

        <form id="request-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Address</label>
                <input type="email" id="step1-email" required class="w-full p-3 mt-1 border rounded-lg dark:bg-gray-700 dark:text-white" placeholder="email@example.com">
            </div>
            <button type="submit" id="request-password-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
                Send Code
            </button>
        </form>

        <form id="reset-form" class="space-y-4 hidden-strict">
            <input type="hidden" id="saved-email">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">6-Digit Code</label>
                <input type="text" id="code" required class="w-full p-3 mt-1 border rounded-lg dark:bg-gray-700 dark:text-white" placeholder="123456">
            </div>

            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Password</label>
                <input type="password" id="new-password" required class="w-full p-3 mt-1 border rounded-lg dark:bg-gray-700 dark:text-white" placeholder="••••••••">
            </div>

            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm New Password</label>
                <input type="password" id="confirm-password" required class="w-full p-3 mt-1 border rounded-lg dark:bg-gray-700 dark:text-white" placeholder="••••••••">
            </div>

            <button type="submit" id="reset-password-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">
                Reset Password
            </button>
        </form>

        <div class="text-center">
            <a href="choose login.html" class="text-blue-600 hover:underline text-sm">Back to Login</a>
        </div>
    </div>

    

    <script>
        const API_URL = '/api/auth';
        const requestForm = document.getElementById('request-form');
        const resetForm = document.getElementById('reset-form');
        const flowStatus = document.getElementById('flow-status');
        const messageArea = document.getElementById('message-area');
        const requestPasswordBtn = document.getElementById('request-password-btn');
        const resetPasswordBtn = document.getElementById('reset-password-btn');

        function showMessage(type, text) {
            if (!messageArea) return;
            messageArea.textContent = text;
            messageArea.className = `p-3 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageArea.classList.remove('hidden');
        }

        // STEP 1: Send the email code
        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('step1-email').value;
            
            requestPasswordBtn.disabled = true;
            requestPasswordBtn.textContent = 'Sending...';

            try {
                const res = await fetch(`${API_URL}/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (res.ok) {
                    showMessage('success', 'Code sent! Please check your email inbox.');
                    document.getElementById('saved-email').value = email;
                    requestForm.classList.add('hidden-strict');
                    resetForm.classList.remove('hidden-strict');
                    flowStatus.textContent = 'Step 2: Enter the code and your new password.';
                } else {
                    showMessage('error', data.message || 'Email not found.');
                }
            } catch (err) {
                showMessage('error', 'Connection error. Please try again.');
            } finally {
                requestPasswordBtn.disabled = false;
                requestPasswordBtn.textContent = 'Send Code';
            }
        });

        // STEP 2: Reset the password with confirmation check
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('saved-email').value;
            const code = document.getElementById('code').value.trim();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // 1. Check if passwords match
            if (newPassword !== confirmPassword) {
                showMessage('error', 'Passwords do not match. Please re-enter them.');
                return;
            }

            // 2. Length check (standard security)
            if (newPassword.length < 6) {
                showMessage('error', 'Password must be at least 6 characters long.');
                return;
            }

            resetPasswordBtn.disabled = true;
            resetPasswordBtn.textContent = 'Resetting...';

            try {
                const res = await fetch(`${API_URL}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, newPassword })
                });
                const data = await res.json();

                if (res.ok) {
                    showMessage('success', 'Password reset successful! Redirecting to login...');
                    setTimeout(() => {
                        window.location.href = 'choose login.html';
                    }, 2500);
                } else {
                    showMessage('error', data.message || 'Invalid or expired code.');
                }
            } catch (err) {
                showMessage('error', 'Connection error. Please try again.');
            } finally {
                resetPasswordBtn.disabled = false;
                resetPasswordBtn.textContent = 'Reset Password';
            }
        });
    </script>
</body>
</html>